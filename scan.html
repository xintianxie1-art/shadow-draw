<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>数字皮影人 · 拼豆扫描</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f6e3c2;
      color: #4a3420;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px;
    }
    .sub {
      font-size: 13px;
      color: #7a6144;
      margin-bottom: 16px;
    }
    .wrap {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    @media (min-width: 768px) {
      .wrap {
        flex-direction: row;
        align-items: flex-start;
      }
    }
    .left, .right {
      flex: 1;
    }
    .panel {
      background: #fdf6e6;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .field {
      margin-bottom: 12px;
      font-size: 14px;
    }
    label {
      display: block;
      margin-bottom: 4px;
    }
    input[type="file"] {
      width: 100%;
      font-size: 14px;
    }
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #c49b63;
      background: #fff;
    }
    button {
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      background: #c97a34;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: #fdf6e6;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.18);
    }
    #preview {
      width: 240px;
      height: 320px;
    }
    #status {
      margin-top: 8px;
      font-size: 13px;
      min-height: 1em;
    }
    #status.ok {
      color: #1b7f42;
    }
    #status.err {
      color: #b53030;
    }
    .hint {
      font-size: 12px;
      color: #8a6b48;
      margin-top: 6px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <h1>数字皮影人 · 拼豆扫描</h1>
  <div class="sub">拍摄实体拼豆板 → 自动转换为 24×32 电子拼豆角色 → 保存到 Firebase 角色库。</div>

  <div class="wrap">
    <div class="left">
      <div class="panel">
        <div class="field">
          <label for="characterSelect">角色选择</label>
          <select id="characterSelect">
            <option value="sunwukong">孙悟空</option>
            <option value="tangseng">唐僧</option>
            <option value="bajie">猪八戒</option>
            <option value="shaseng">沙僧</option>
          </select>
        </div>

        <div class="field">
          <label for="fileInput">拼豆照片（建议正对拍摄，板子铺满画面）</label>
          <input id="fileInput" type="file" accept="image/*" capture="environment" />
          <div class="hint">
            建议：在桌面贴一个白色拍摄框，让拼豆板尽量对齐框四边、充满画面。
          </div>
        </div>

        <div class="field">
          <button id="saveBtn" disabled>保存到角色库</button>
          <div id="status"></div>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="panel">
        <label>电子拼豆预览（24×32 网格）</label>
        <canvas id="preview" width="240" height="320"></canvas>
      </div>
    </div>
  </div>

  <!-- 工作画布，用于图像采样，隐藏即可 -->
  <canvas id="workCanvas" width="240" height="320" style="display:none;"></canvas>

  <!-- Firebase + 核心逻辑 -->
  <script type="module">
    // ---------------- Firebase 初始化 ----------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCaRNjmy6kV0IK1zr8LRPRN-oEhrrFxrzk",
      authDomain: "shadow-draw-94af9.firebaseapp.com",
      projectId: "shadow-draw-94af9",
      storageBucket: "shadow-draw-94af9.firebasestorage.app",
      messagingSenderId: "1000953704742",
      appId: "1:1000953704742:web:535a3d8291f84a645611e7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---------------- 基本参数 ----------------
    const rows = 32;
    const cols = 24;

    // 8 色皮影调色板
    const palette = [
      "#2b1b0f", // 深棕（轮廓）
      "#b73527", // 深红
      "#e36b2c", // 橙红
      "#f1c232", // 金黄
      "#f7d9b0", // 肤色
      "#5b7f6e", // 墨绿
      "#2e4a6b", // 青蓝
      "#ffffff"  // 留白
    ];

    let gridData = Array.from({ length: rows }, () =>
      Array.from({ length: cols }, () => "#ffffff")
    );

    const fileInput = document.getElementById("fileInput");
    const preview = document.getElementById("preview");
    const previewCtx = preview.getContext("2d");
    const workCanvas = document.getElementById("workCanvas");
    const workCtx = workCanvas.getContext("2d");
    const saveBtn = document.getElementById("saveBtn");
    const statusEl = document.getElementById("status");
    const characterSelect = document.getElementById("characterSelect");

    let hasImage = false;

    // 最近颜色查找
    function nearestColor(r0, g0, b0) {
      let bestHex = palette[0];
      let bestDist = Infinity;
      for (const hex of palette) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        const d = (r - r0) ** 2 + (g - g0) ** 2 + (b - b0) ** 2;
        if (d < bestDist) {
          bestDist = d;
          bestHex = hex;
        }
      }
      return bestHex;
    }

    // 渲染预览像素图
    function renderPreview() {
      const cellW = preview.width / cols;
      const cellH = preview.height / rows;
      previewCtx.clearRect(0, 0, preview.width, preview.height);

      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          previewCtx.fillStyle = gridData[r][c];
          previewCtx.fillRect(c * cellW, r * cellH, cellW, cellH);
        }
      }

      // 画网格线（淡）
      previewCtx.strokeStyle = "rgba(0,0,0,0.08)";
      previewCtx.lineWidth = 1;
      for (let c = 0; c <= cols; c++) {
        const x = c * cellW;
        previewCtx.beginPath();
        previewCtx.moveTo(x, 0);
        previewCtx.lineTo(x, preview.height);
        previewCtx.stroke();
      }
      for (let r = 0; r <= rows; r++) {
        const y = r * cellH;
        previewCtx.beginPath();
        previewCtx.moveTo(0, y);
        previewCtx.lineTo(preview.width, y);
        previewCtx.stroke();
      }
    }

    // 处理上传图片
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => {
        // 将图片按“cover”方式画到工作画布上
        const cw = workCanvas.width;
        const ch = workCanvas.height;
        workCtx.clearRect(0, 0, cw, ch);

        const scale = Math.max(cw / img.width, ch / img.height);
        const dw = img.width * scale;
        const dh = img.height * scale;
        const dx = (cw - dw) / 2;
        const dy = (ch - dh) / 2;
        workCtx.drawImage(img, dx, dy, dw, dh);

        // 抽样到 24x32
        const cellW = cw / cols;
        const cellH = ch / rows;
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            const sx = Math.floor((c + 0.5) * cellW);
            const sy = Math.floor((r + 0.5) * cellH);
            const data = workCtx.getImageData(sx, sy, 1, 1).data;
            const color = nearestColor(data[0], data[1], data[2]);
            gridData[r][c] = color;
          }
        }

        renderPreview();
        hasImage = true;
        saveBtn.disabled = false;
        setStatus("已生成预览，可保存到角色库。", "ok");

        URL.revokeObjectURL(url);
      };
      img.onerror = () => {
        setStatus("图片加载失败，请换一张试试。", "err");
        URL.revokeObjectURL(url);
      };
      img.src = url;
    });

    function setStatus(msg, type) {
      statusEl.textContent = msg || "";
      statusEl.className = "";
      if (type === "ok") statusEl.classList.add("ok");
      if (type === "err") statusEl.classList.add("err");
    }

    // 保存到 Firebase 角色库
    saveBtn.addEventListener("click", async () => {
      if (!hasImage) return;
      saveBtn.disabled = true;
      setStatus("保存中…", "");

      const charId = characterSelect.value || "unknown";
      const previewDataURL = preview.toDataURL("image/png");

      try {
        await set(ref(db, "characters/" + charId), {
          grid: gridData,
          preview: previewDataURL,
          updatedAt: Date.now()
        });
        setStatus("已保存到角色库：" + charId, "ok");
      } catch (err) {
        console.error(err);
        setStatus("保存失败，请检查网络或 Firebase 配置。", "err");
      } finally {
        saveBtn.disabled = !hasImage;
      }
    });

    // 初始空预览
    renderPreview();
  </script>
</body>
</html>
