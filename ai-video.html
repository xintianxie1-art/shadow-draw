<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>æ•°å­—çš®å½±äºº Â· AI è§†é¢‘ç”Ÿæˆç³»ç»Ÿï¼ˆæŠ å›¾ + æ‰‹è‡‚åŠ¨ä½œç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body {
  background: #f7e9c9;
  font-family: system-ui;
  padding: 20px;
  color: #4a3a27;
}
.container {
  max-width: 900px;
  margin: auto;
  background: #fffdf6;
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 12px 32px rgba(0,0,0,0.15);
}
h1 { margin-bottom: 10px; }
label { font-size: 14px; font-weight: 600; }
input { margin: 8px 0 18px; }
#log {
  background: #1b1b1b;
  color: #eee;
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
  height: 160px;
  overflow-y: auto;
  font-family: monospace;
  font-size: 12px;
}
#preview {
  margin-top: 20px;
  text-align: center;
}
canvas, video {
  max-width: 100%;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.25);
}
button {
  padding: 12px 20px;
  margin-top: 8px;
  width: 100%;
  border: none;
  background: #d29a38;
  color: white;
  border-radius: 10px;
  font-size: 15px;
  cursor: pointer;
}
button:hover {
  background: #c28825;
}
small {
  display: block;
  font-size: 12px;
  color: #7b6a4a;
  margin-top: -12px;
  margin-bottom: 16px;
}
</style>
</head>
<body>

<div class="container">
  <h1>AI è§†é¢‘ç”Ÿæˆï¼ˆæŠ å›¾ + æ‰‹è‡‚åŠ¨ä½œç‰ˆï¼‰</h1>
  <p>
    ä¸Šä¼ ä¸¤ä¸ªæ‹¼è±†è§’è‰² â†’ è‡ªåŠ¨æŠ æ‰ç™½è‰²èƒŒæ™¯ â†’ æ ¹æ®è§’è‰² A é…è‰²ç”Ÿæˆ AI åœºæ™¯ â†’
    æŠŠè§’è‰²åˆ‡åˆ†ä¸ºã€Œå¤´ / èº«ä½“ / è…¿ã€å¹¶åŠ ä¸Š<b>å·¦å³æ‰‹è‡‚æŒ¥åŠ¨</b> â†’ å½•åˆ¶ 5 ç§’ AI è§†é¢‘ï¼ˆwebmï¼‰ã€‚
  </p>

  <label>â‘  ä¸Šä¼ è§’è‰² Aï¼ˆä¾‹å¦‚å­™æ‚Ÿç©ºï¼‰</label><br>
  <input id="charImgA" type="file" accept="image/*">
  <small>ç³»ç»Ÿä¼šæ ¹æ®è§’è‰² A çš„é¢œè‰²ç”Ÿæˆ AI åœºæ™¯èƒŒæ™¯ï¼ŒåŒæ—¶æŠ æ‰ç™½åº•ã€‚</small>

  <label>â‘¡ ä¸Šä¼ è§’è‰² Bï¼ˆä¾‹å¦‚å”åƒ§ / çŒªå…«æˆ’ / æ²™åƒ§ï¼‰</label><br>
  <input id="charImgB" type="file" accept="image/*">
  <small>è§’è‰² B ä¼šä»å¦ä¸€ä¾§è¿›å…¥ï¼Œä¸è§’è‰² A äº§ç”Ÿäº’åŠ¨ã€‚</small>

  <button id="genBtn" onclick="generate()">ç”Ÿæˆ AI è§†é¢‘ï¼ˆçº¦ 5 ç§’ï¼‰</button>

  <div id="log"></div>
  <div id="preview"></div>
</div>

<script>
// æ—¥å¿—
function log(msg) {
  const box = document.getElementById("log");
  box.innerHTML += msg + "<br>";
  box.scrollTop = box.scrollHeight;
}

// è¯»å›¾
async function loadImage(file) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.src = URL.createObjectURL(file);
  });
}

// 1âƒ£ æŠŠç™½è‰²èƒŒæ™¯æŠ æˆé€æ˜ï¼šæ¥è¿‘ç™½è‰²ï¼ˆRGB > 240ï¼‰çš„åƒç´ ç›´æ¥ alpha=0
function createSpriteWithoutWhite(img) {
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  canvas.width = img.width;
  canvas.height = img.height;

  ctx.drawImage(img, 0, 0);

  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;

  for (let i = 0; i < data.length; i += 4) {
    const r = data[i];
    const g = data[i + 1];
    const b = data[i + 2];
    // å¦‚æœæ¥è¿‘ç™½è‰²ï¼Œå°±é€æ˜
    if (r > 240 && g > 240 && b > 240) {
      data[i + 3] = 0;
    }
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.putImageData(imageData, 0, 0);

  return canvas;
}

// 2âƒ£ åŸºäºæŠ è¿‡å›¾çš„ sprite æå–ä¸»è‰²ï¼ˆé¿å…ç™½åº•å¹²æ‰°ï¼‰
function getAverageColorFromSprite(sprite) {
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  canvas.width = sprite.width;
  canvas.height = sprite.height;
  ctx.drawImage(sprite, 0, 0);

  const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

  let r = 0, g = 0, b = 0, count = 0;
  for (let i = 0; i < data.length; i += 4) {
    const alpha = data[i + 3];
    if (alpha < 10) continue;
    r += data[i];
    g += data[i + 1];
    b += data[i + 2];
    count++;
  }
  if (!count) count = 1;
  r = Math.round(r / count);
  g = Math.round(g / count);
  b = Math.round(b / count);
  return { r, g, b };
}

// äº’è¡¥è‰²
function getComplementColor({ r, g, b }) {
  return { r: 255 - r, g: 255 - g, b: 255 - b };
}

// rgb â†’ å­—ç¬¦ä¸²
function rgbStr({ r, g, b }, alpha = 1) {
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

/**
 * 3âƒ£ åˆ†æ®µæœ¨å¶ + æ‰‹è‡‚åŠ¨ä½œ
 * - çºµå‘åˆ‡ä¸‰æ®µï¼šå¤´ / èº«ä½“ / è…¿
 * - å†åœ¨èº«ä½“é‚£ä¸€æ®µå·¦å³å„åˆ‡å‡ºä¸€æ¡â€œæ‰‹è‡‚æ¡â€ï¼Œç»•â€œè‚©å…³èŠ‚â€æ—‹è½¬æŒ¥åŠ¨
 */
function drawPuppet(ctx, sprite, centerX, baseY, scale, t, phase) {
  const sw = sprite.width;
  const sh = sprite.height;
  const segH = sh / 3;           // æ¯æ®µåŸå§‹é«˜åº¦
  const segHScaled = segH * scale;
  const fullW = sw * scale;

  // æ•´ä½“è½»å¾®å·¦å³æ‘†
  const swayX = Math.sin(t * 2 * Math.PI + phase) * 4;

  // å…ˆç”»ä¸‰æ®µï¼ˆå¤´ / èº« / è…¿ï¼‰
  for (let i = 0; i < 3; i++) {
    const sy = i * segH;
    const dx = centerX + swayX;
    const segmentBottom = baseY - (2 - i) * segHScaled;
    const segmentTop    = segmentBottom - segHScaled;

    let offsetY = 0;
    if (i === 0) {
      // å¤´ï¼šç‚¹å¤´
      offsetY = Math.sin(t * 4 * Math.PI + phase) * 3;
    } else if (i === 1) {
      // èº«ä½“ï¼šè½»å¾®èµ·ä¼
      offsetY = Math.sin(t * 3 * Math.PI + phase) * 2;
    } else {
      // è…¿ï¼šèµ°è·¯
      offsetY = Math.sin(t * 6 * Math.PI + phase) * 4;
    }

    ctx.drawImage(
      sprite,
      0, sy,             // æºå›¾èµ·ç‚¹
      sw, segH,          // æºå›¾å¤§å°
      dx - fullW / 2,    // ç›®æ ‡ X ä¸­å¿ƒ
      segmentTop + offsetY, // ç›®æ ‡ Y
      fullW, segHScaled
    );
  }

  // å†ç”»ä¸¤æ¡â€œæ‰‹è‡‚æ¡â€ï¼ˆä»èº«ä½“é‚£æ®µå·¦å³å„åˆ‡å‡ºä¸€æ¡ï¼‰
  const bodyTop    = baseY - 2 * segHScaled;
  const bodyBottom = baseY - segHScaled;
  const bodyMidY   = (bodyTop + bodyBottom) / 2;

  const armSrcHeight = segH * 0.9;     // ä»èº«ä½“æ®µé‡Œæˆªå–ä¸€æ¡è¿‘ä¼¼â€œæ‰‹è‡‚â€çš„ç«–æ¡
  const armSrcY      = segH + (segH - armSrcHeight) / 2;
  const armSrcWidth  = sw * 0.28;      // å·¦å³å„ 28% ä½œä¸ºæ‰‹è‡‚
  const armDestH     = armSrcHeight * scale;
  const armDestW     = armSrcWidth * scale;

  // æ‰‹è‡‚æ‘†åŠ¨è§’åº¦
  const armAngle = Math.sin(t * 4 * Math.PI + phase) * 0.35; // å·¦å³ Â±20Â°
  const dxBase = centerX + swayX;
  const shoulderOffsetX = fullW * 0.45;  // è‚©å…³èŠ‚ç¦»èº«ä½“ä¸­å¿ƒçš„æ°´å¹³è·ç¦»
  const shoulderY = bodyMidY;            // è‚©å…³èŠ‚é«˜åº¦

  // å·¦è‡‚
  ctx.save();
  ctx.translate(dxBase - shoulderOffsetX, shoulderY);
  ctx.rotate(armAngle); // å·¦è‡‚è·Ÿç€æ­£å‘è§’åº¦
  ctx.drawImage(
    sprite,
    0, armSrcY,                  // æºå›¾å·¦è‡‚èµ·ç‚¹
    armSrcWidth, armSrcHeight,
    -armDestW / 2,              // ä»¥è‚©å…³èŠ‚ä¸ºå‚è€ƒç‚¹å¾€ä¸‹ç”»
    0,
    armDestW, armDestH
  );
  ctx.restore();

  // å³è‡‚
  ctx.save();
  ctx.translate(dxBase + shoulderOffsetX, shoulderY);
  ctx.rotate(-armAngle); // å³è‡‚åå‘æ—‹è½¬
  ctx.drawImage(
    sprite,
    sw - armSrcWidth, armSrcY,  // æºå›¾å³è‡‚èµ·ç‚¹
    armSrcWidth, armSrcHeight,
    -armDestW / 2,
    0,
    armDestW, armDestH
  );
  ctx.restore();
}

let animId = null;

async function generate() {
  const fileA = document.getElementById("charImgA").files[0];
  const fileB = document.getElementById("charImgB").files[0];

  if (!fileA || !fileB) {
    log("âŒ éœ€è¦åŒæ—¶ä¸Šä¼ è§’è‰² A å’Œè§’è‰² B");
    return;
  }

  if (animId !== null) {
    cancelAnimationFrame(animId);
    animId = null;
  }

  document.getElementById("preview").innerHTML = "";
  document.getElementById("log").innerHTML = "";

  log("âœ” åŠ è½½è§’è‰² A å›¾åƒ...");
  const rawA = await loadImage(fileA);

  log("âœ” åŠ è½½è§’è‰² B å›¾åƒ...");
  const rawB = await loadImage(fileB);

  log("âœ‚ æ­£åœ¨è‡ªåŠ¨æŠ å›¾ï¼ˆå»é™¤ç™½è‰²èƒŒæ™¯ï¼‰...");
  const spriteA = createSpriteWithoutWhite(rawA);
  const spriteB = createSpriteWithoutWhite(rawB);

  log("ğŸ§  åŸºäºæŠ å›¾ç»“æœåˆ†æè§’è‰² A é…è‰²ï¼Œæ„å»º AI åœºæ™¯é£æ ¼å‘é‡...");
  const mainColor = getAverageColorFromSprite(spriteA);
  const compColor = getComplementColor(mainColor);
  log(`ğŸ¨ è§’è‰² A ä¸»è‰²ï¼šrgb(${mainColor.r}, ${mainColor.g}, ${mainColor.b})`);

  // åˆ›å»º canvas
  const canvas = document.createElement("canvas");
  canvas.width = 480;
  canvas.height = 320;
  const ctx = canvas.getContext("2d");
  document.getElementById("preview").appendChild(canvas);

  log("ğŸŒ è°ƒç”¨ AI è§†é¢‘ç”Ÿæˆæ¥å£ï¼ˆæ¨¡æ‹Ÿï¼šåŸºäºè§’è‰²å›¾ + åœºæ™¯å‘é‡ç”Ÿæˆå…³é”®å¸§ï¼‰...");

  // ä½¿ç”¨ MediaRecorder å½•åˆ¶ canvas åŠ¨ç”»
  const stream = canvas.captureStream(30); // 30fps
  let recorder;
  let chunks = [];

  try {
    recorder = new MediaRecorder(stream, {
      mimeType: 'video/webm;codecs=vp9'
    });
  } catch (e) {
    recorder = new MediaRecorder(stream);
  }

  recorder.ondataavailable = e => {
    if (e.data && e.data.size > 0) {
      chunks.push(e.data);
    }
  };

  recorder.onstop = () => {
    log("ğŸ‰ AI è§†é¢‘ç”Ÿæˆå®Œæˆï¼ˆå½•åˆ¶ç»“æŸï¼‰ï¼");
    const blob = new Blob(chunks, { type: 'video/webm' });
    const url = URL.createObjectURL(blob);

    const html = `
      <h3>AI ç”Ÿæˆè§†é¢‘ç»“æœï¼š</h3>
      <video controls src="${url}"></video>
      <br><br>
      <a href="${url}" download="ai-video.webm">ç‚¹å‡»ä¸‹è½½ ai-video.webm</a>
    `;
    document.getElementById("preview").innerHTML = html;
  };

  // å¼€å§‹å½•åˆ¶
  chunks = [];
  recorder.start();
  log("ğŸ¥ å¼€å§‹å½•åˆ¶ AI åœºæ™¯åŠ¨ç”»ï¼ˆçº¦ 5 ç§’ï¼‰...");

  const recordDuration = 5000; // 5 ç§’
  const startTime = performance.now();

  function renderFrame(now) {
    const elapsed = now - startTime;
    const t = (elapsed / recordDuration) % 1;  // 0 ~ 1

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // === 1. AI åœºæ™¯èƒŒæ™¯ ===
    const cx = canvas.width / 2;
    const cy = canvas.height / 2;

    const grad = ctx.createRadialGradient(
      cx, cy, 40,
      cx, cy, 260
    );
    grad.addColorStop(0, rgbStr(compColor, 0.95));
    grad.addColorStop(0.45, rgbStr(mainColor, 0.85));
    grad.addColorStop(1, "rgba(5, 5, 15, 0.95)");

    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const dots = 32;
    for (let j = 0; j < dots; j++) {
      const angle = (j / dots) * Math.PI * 2 + t * 2;
      const radius = 30 + (j * 6);
      const x = canvas.width / 2 + Math.cos(angle) * radius;
      const y = canvas.height / 2 + Math.sin(angle) * radius;
      const size = 2 + (j % 4);

      ctx.beginPath();
      ctx.fillStyle = (j % 2 === 0)
        ? rgbStr(mainColor, 0.18 + (j % 3) * 0.05)
        : rgbStr(compColor, 0.18 + (j % 3) * 0.05);
      ctx.arc(x, y, size, 0, Math.PI * 2);
      ctx.fill();
    }

    // === 2. åŒè§’è‰²äº’åŠ¨è½¨è¿¹ + æœ¨å¶ + æ‰‹è‡‚ ===
    const baseY = canvas.height * 0.82; // åœ°é¢

    // é™åˆ¶æœ€å¤§é«˜åº¦
    const maxH = canvas.height * 0.6;
    const baseScaleA = Math.min(maxH / spriteA.height, 1.1);
    const baseScaleB = Math.min(maxH / spriteB.height, 1.1);

    const scaleA = baseScaleA * (0.96 + 0.04 * Math.sin(t * Math.PI));
    const scaleB = baseScaleB * (0.96 + 0.04 * Math.cos(t * Math.PI));

    // A ä»å·¦å‘ä¸­é—´
    const aProgress = Math.min(1, t * 1.2);
    const ax = canvas.width * (0.18 + 0.22 * aProgress);

    // B ä»å³å‘ä¸­é—´
    const bProgress = Math.min(1, (t - 0.1) * 1.2 + 0.1);
    const bx = canvas.width * (0.82 - 0.22 * Math.max(0, bProgress));

    // é˜´å½±
    ctx.save();
    ctx.globalAlpha = 0.35;
    ctx.fillStyle = "black";
    ctx.beginPath();
    ctx.ellipse(ax, baseY + 4, spriteA.width * scaleA * 0.45, 10, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(bx, baseY + 4, spriteB.width * scaleB * 0.45, 10, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();

    // ç”»å¸¦æ‰‹è‡‚çš„æœ¨å¶
    drawPuppet(ctx, spriteA, ax, baseY, scaleA, t, 0.0);
    drawPuppet(ctx, spriteB, bx, baseY, scaleB, t, Math.PI / 3);

    // ä¸­é—´â€œå¯¹è¯â€å…‰å¸¦
    if (t > 0.3 && t < 0.8) {
      ctx.beginPath();
      const midY = baseY - 40;
      const opacity = 0.45 + Math.sin(t * Math.PI) * 0.2;
      ctx.strokeStyle = rgbStr(compColor, opacity);
      ctx.lineWidth = 3;
      ctx.moveTo(ax + spriteA.width * scaleA * 0.2, midY);
      ctx.lineTo(bx - spriteB.width * scaleB * 0.2, midY);
      ctx.stroke();
    }

    if (elapsed < recordDuration) {
      animId = requestAnimationFrame(renderFrame);
    } else {
      cancelAnimationFrame(animId);
      animId = null;
      recorder.stop();
      log("â¹ åœæ­¢å½•åˆ¶ï¼Œæ­£åœ¨ç”Ÿæˆè§†é¢‘æ–‡ä»¶...");
    }
  }

  animId = requestAnimationFrame(renderFrame);
}
</script>

</body>
</html>
