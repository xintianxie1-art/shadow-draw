<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>æ•°å­—çš®å½±äºº Â· AI è§†é¢‘ç”Ÿæˆç³»ç»Ÿï¼ˆå®æ—¶é¢„è§ˆç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body {
  background: #f7e9c9;
  font-family: system-ui;
  padding: 20px;
  color: #4a3a27;
}
.container {
  max-width: 900px;
  margin: auto;
  background: #fffdf6;
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 12px 32px rgba(0,0,0,0.15);
}
h1 { margin-bottom: 10px; }
label { font-size: 14px; font-weight: 600; }
input { margin: 8px 0 18px; }
#log {
  background: #1b1b1b;
  color: #eee;
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
  height: 140px;
  overflow-y: auto;
  font-family: monospace;
  font-size: 12px;
}
#preview {
  margin-top: 20px;
  text-align: center;
}
canvas {
  max-width: 100%;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.25);
}
button {
  padding: 12px 20px;
  margin-top: 8px;
  width: 100%;
  border: none;
  background: #d29a38;
  color: white;
  border-radius: 10px;
  font-size: 15px;
  cursor: pointer;
}
button:hover {
  background: #c28825;
}
small {
  display: block;
  font-size: 12px;
  color: #7b6a4a;
  margin-top: -12px;
  margin-bottom: 16px;
}
</style>
</head>
<body>

<div class="container">
  <h1>AI è§†é¢‘ç”Ÿæˆï¼ˆåŒè§’è‰² Â· å®æ—¶é¢„è§ˆç‰ˆï¼‰</h1>
  <p>
    ä¸Šä¼ ä¸¤ä¸ªæ‹¼è±†è§’è‰² â†’ æå–è§’è‰² A é…è‰²ç”Ÿæˆ AI åœºæ™¯èƒŒæ™¯ â†’
    è®©ä¸¤ä¸ªè§’è‰²åœ¨åœºæ™¯ä¸­ç›¸é‡ / å¯¹è¯ï¼Œ<b>ä»¥å®æ—¶åŠ¨ç”»çš„å½¢å¼æ’­æ”¾</b>ï¼Œæ¨¡æ‹Ÿ AI ç”Ÿæˆçš„è§†é¢‘ã€‚
  </p>

  <label>â‘  ä¸Šä¼ è§’è‰² Aï¼ˆä¾‹å¦‚å­™æ‚Ÿç©ºï¼‰</label><br>
  <input id="charImgA" type="file" accept="image/*">
  <small>ç³»ç»Ÿä¼šä½¿ç”¨è§’è‰² A çš„é¢œè‰²ç”Ÿæˆ AI åœºæ™¯èƒŒæ™¯ã€‚</small>

  <label>â‘¡ ä¸Šä¼ è§’è‰² Bï¼ˆä¾‹å¦‚å”åƒ§/çŒªå…«æˆ’/æ²™åƒ§ï¼‰</label><br>
  <input id="charImgB" type="file" accept="image/*">
  <small>è§’è‰² B å°†ä»å¦ä¸€ä¾§è¿›å…¥ï¼Œä¸è§’è‰² A äº§ç”Ÿäº’åŠ¨ã€‚</small>

  <button id="genBtn" onclick="generate()">ç”Ÿæˆå¹¶æ’­æ”¾ AI è§†é¢‘</button>

  <div id="log"></div>
  <div id="preview"></div>
</div>

<script>
// æ—¥å¿—
function log(msg) {
  const box = document.getElementById("log");
  box.innerHTML += msg + "<br>";
  box.scrollTop = box.scrollHeight;
}

// è¯»å›¾
async function loadImage(file) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.src = URL.createObjectURL(file);
  });
}

// ä»è§’è‰²å›¾é‡Œæå–ä¸»è‰²
function getAverageColor(img) {
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  const size = 64;
  canvas.width = size;
  canvas.height = size;

  ctx.drawImage(img, 0, 0, size, size);
  const data = ctx.getImageData(0, 0, size, size).data;

  let r = 0, g = 0, b = 0, count = 0;
  for (let i = 0; i < data.length; i += 4) {
    const alpha = data[i + 3];
    if (alpha < 40) continue;
    r += data[i];
    g += data[i + 1];
    b += data[i + 2];
    count++;
  }
  if (!count) count = 1;
  r = Math.round(r / count);
  g = Math.round(g / count);
  b = Math.round(b / count);
  return { r, g, b };
}

// äº’è¡¥è‰²
function getComplementColor({ r, g, b }) {
  return { r: 255 - r, g: 255 - g, b: 255 - b };
}

// rgb â†’ å­—ç¬¦ä¸²
function rgbStr({ r, g, b }, alpha = 1) {
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

let animId = null;

async function generate() {
  const fileA = document.getElementById("charImgA").files[0];
  const fileB = document.getElementById("charImgB").files[0];

  if (!fileA || !fileB) {
    log("âŒ éœ€è¦åŒæ—¶ä¸Šä¼ è§’è‰² A å’Œè§’è‰² B");
    return;
  }

  // å¦‚æœä¹‹å‰æœ‰åŠ¨ç”»ï¼Œå…ˆåœæ‰
  if (animId !== null) {
    cancelAnimationFrame(animId);
    animId = null;
  }

  document.getElementById("preview").innerHTML = "";
  document.getElementById("log").innerHTML = "";

  log("âœ” åŠ è½½è§’è‰² A å›¾åƒ...");
  const imgA = await loadImage(fileA);

  log("âœ” åŠ è½½è§’è‰² B å›¾åƒ...");
  const imgB = await loadImage(fileB);

  log("ğŸ§  åˆ†æè§’è‰² A é…è‰²ï¼Œç”Ÿæˆ AI åœºæ™¯é£æ ¼å‘é‡...");
  const mainColor = getAverageColor(imgA);
  const compColor = getComplementColor(mainColor);
  log(`ğŸ¨ è§’è‰² A ä¸»è‰²ï¼šrgb(${mainColor.r}, ${mainColor.g}, ${mainColor.b})`);

  // åˆ›å»º canvas ä½œä¸ºâ€œè§†é¢‘æ’­æ”¾å™¨â€
  const canvas = document.createElement("canvas");
  canvas.width = 480;
  canvas.height = 320;
  const ctx = canvas.getContext("2d");
  document.getElementById("preview").appendChild(canvas);

  log("ğŸš€ å®æ—¶æ¸²æŸ“ AI åœºæ™¯ + åŒè§’è‰²äº’åŠ¨åŠ¨ç”»ä¸­...");

  let startTime = null;

  function renderFrame(timestamp) {
    if (!startTime) startTime = timestamp;
    const elapsed = timestamp - startTime;
    const t = (elapsed / 2000) % 1;  // 2 ç§’ä¸€ä¸ªå¾ªç¯ï¼Œ0 ~ 1

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // === 1. AI èƒŒæ™¯ï¼šåŠ¨æ€æ¸å˜ + å…‰æ–‘ ===
    const cx = canvas.width / 2 + Math.sin(t * Math.PI * 2) * 80;
    const cy = canvas.height / 2 + Math.cos(t * Math.PI * 2) * 60;

    const grad = ctx.createRadialGradient(
      cx, cy, 40,
      canvas.width / 2, canvas.height / 2, 380
    );
    grad.addColorStop(0, rgbStr(mainColor, 0.95));
    grad.addColorStop(0.5, rgbStr(compColor, 0.85));
    grad.addColorStop(1, "rgba(10, 10, 10, 0.9)");

    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const dots = 32;
    for (let j = 0; j < dots; j++) {
      const angle = (j / dots) * Math.PI * 2 + t * 2;
      const radius = 40 + (j * 6);
      const x = canvas.width / 2 + Math.cos(angle) * radius;
      const y = canvas.height / 2 + Math.sin(angle) * radius;
      const size = 2 + (j % 4);

      ctx.beginPath();
      ctx.fillStyle = (j % 2 === 0)
        ? rgbStr(mainColor, 0.15 + (j % 3) * 0.05)
        : rgbStr(compColor, 0.15 + (j % 3) * 0.05);
      ctx.arc(x, y, size, 0, Math.PI * 2);
      ctx.fill();
    }

    // === 2. åŒè§’è‰²äº’åŠ¨è½¨è¿¹ ===
    const baseY = canvas.height * 0.7;

    // è§’è‰² Aï¼šå·¦å‘ä¸­é—´
    const aProgress = t; // 0 -> 1
    const ax = canvas.width * (0.1 + 0.3 * aProgress);
    const ay = baseY + Math.sin(t * Math.PI * 2) * 5;

    // è§’è‰² Bï¼šå³å‘ä¸­é—´
    const bProgress = t;
    const bx = canvas.width * (0.9 - 0.3 * bProgress);
    const by = baseY + Math.cos(t * Math.PI * 2) * 5;

    const scaleA = 0.6 + Math.sin(t * Math.PI) * 0.05;
    const scaleB = 0.6 + Math.cos(t * Math.PI) * 0.05;

    const wA = imgA.width * scaleA;
    const hA = imgA.height * scaleA;

    const wB = imgB.width * scaleB;
    const hB = imgB.height * scaleB;

    ctx.globalAlpha = 0.97;

    // è§’è‰² A
    ctx.drawImage(
      imgA,
      ax - wA / 2,
      ay - hA,
      wA, hA
    );

    // è§’è‰² B
    ctx.drawImage(
      imgB,
      bx - wB / 2,
      by - hB,
      wB, hB
    );

    ctx.globalAlpha = 1;

    // ä¸­é—´å‡ ä¹â€œå¯¹è¯â€çš„æ—¶å€™ï¼Œç”»ä¸€æ¡å…‰å¸¦
    if (t > 0.3 && t < 0.7) {
      ctx.beginPath();
      const midY = baseY - 40;
      const opacity = 0.35 + Math.sin(t * Math.PI) * 0.2;
      ctx.strokeStyle = rgbStr(compColor, opacity);
      ctx.lineWidth = 3;
      ctx.moveTo(ax + wA * 0.2, midY);
      ctx.lineTo(bx - wB * 0.2, midY);
      ctx.stroke();
    }

    animId = requestAnimationFrame(renderFrame);
  }

  animId = requestAnimationFrame(renderFrame);
  log("âœ… å®æ—¶ AI è§†é¢‘å·²å¼€å§‹æ’­æ”¾ï¼ˆå¾ªç¯åŠ¨ç”»ï¼Œå¯ç”¨äºè¯¾å ‚å±•ç¤ºï¼‰ã€‚");
}
</script>

</body>
</html>
