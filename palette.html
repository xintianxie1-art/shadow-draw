<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>AI Color Palette Generator v2.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 30px;
    background: #f5f6f8;
  }
  h1 { margin-bottom: 10px; }
  #preview {
    max-width: 240px;
    margin-top: 15px;
    border-radius: 10px;
  }
  #palette {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-top: 25px;
  }
  .color-box {
    height: 70px;
    border-radius: 10px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:#000;
    font-weight:bold;
  }
</style>

</head>
<body>

<h1>ğŸ¨ AI Color Palette Generator v2.0</h1>
<p>åŸºäºã€Œsunwukong.jpgã€è‡ªåŠ¨ç”Ÿæˆç²¾å‡† 8 è‰²è°ƒè‰²æ¿ï¼ˆè¿‡æ»¤èƒŒæ™¯ + KMeansï¼‰</p>

<img id="preview" />

<canvas id="canvas" style="display:none;"></canvas>

<h2>AI ç”Ÿæˆçš„è°ƒè‰²æ¿ï¼š</h2>
<div id="palette"></div>

<script>
// ---- KMEANS ----
function kmeans(pixels, k = 8, maxIter = 12) {
  let centers = [];
  for (let i = 0; i < k; i++) {
    const p = pixels[Math.floor(Math.random() * pixels.length)];
    centers.push([...p]);
  }

  for (let iter = 0; iter < maxIter; iter++) {
    let groups = Array.from({ length: k }, () => []);

    pixels.forEach(p => {
      let minDist = Infinity, idx = 0;
      centers.forEach((c, i) => {
        const d = (p[0]-c[0])**2 + (p[1]-c[1])**2 + (p[2]-c[2])**2;
        if (d < minDist) { minDist = d; idx = i; }
      });
      groups[idx].push(p);
    });

    for (let i = 0; i < k; i++) {
      if (groups[i].length === 0) continue;
      let r=0,g=0,b=0;
      groups[i].forEach(p => { r+=p[0]; g+=p[1]; b+=p[2]; });
      centers[i] = [
        Math.round(r/groups[i].length),
        Math.round(g/groups[i].length),
        Math.round(b/groups[i].length)
      ];
    }
  }
  return centers;
}

// ---- ä»å›¾ç‰‡é‡‡æ ·ï¼ˆè¿‡æ»¤ç™½èƒŒæ™¯ï¼‰ ----
function getPixels(img, canvas) {
  const ctx = canvas.getContext("2d");
  canvas.width = 260;
  canvas.height = 260 * (img.height / img.width);
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

  let pixels = [];

  for (let i = 0; i < data.length; i += 4) {
    let r = data[i], g = data[i+1], b = data[i+2];

    // â—è¿‡æ»¤ç™½è‰²åŒºåŸŸï¼ˆèƒŒæ™¯ï¼‰
    if (r > 240 && g > 240 && b > 240) continue;

    pixels.push([r, g, b]);
  }

  return pixels;
}

// ---- æ¸²æŸ“è°ƒè‰²æ¿ ----
function renderPalette(colors) {
  const container = document.getElementById("palette");
  container.innerHTML = "";

  colors.forEach(rgb => {
    const hex = "#" + rgb.map(v => v.toString(16).padStart(2,"0")).join("");
    const div = document.createElement("div");
    div.className = "color-box";
    div.style.background = hex;

    // å­—ä½“é¢œè‰²é»‘/ç™½è‡ªåŠ¨é€‚é…
    const brightness = rgb[0]*0.299 + rgb[1]*0.587 + rgb[2]*0.114;
    div.style.color = brightness > 180 ? "#000" : "#fff";

    div.textContent = hex;
    container.appendChild(div);
  });
}

// ---- è‡ªåŠ¨è½½å…¥ sunwukong.jpg ----
window.onload = function() {
  const img = document.getElementById("preview");
  img.src = "sunwukong.jpg";

  img.onload = function () {
    const canvas = document.getElementById("canvas");
    const pixels = getPixels(img, canvas);

    const colors = kmeans(pixels, 8);

    // â—æ’åºï¼šè®©é¢œè‰²ä»äº®åˆ°æš—æœ‰åºæ’åˆ—ï¼ˆæ›´å¥½çœ‹ï¼‰
    colors.sort((a,b)=>{
      let ba = a[0]*0.299 + a[1]*0.587 + a[2]*0.114;
      let bb = b[0]*0.299 + b[1]*0.587 + b[2]*0.114;
      return ba - bb;
    });

    renderPalette(colors);
  }
};
</script>

</body>
</html>
